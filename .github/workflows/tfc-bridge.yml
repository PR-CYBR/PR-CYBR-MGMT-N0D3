name: Terraform Cloud Bridge

on:
  push:
    branches: [main, prod]
    paths:
      - 'config/terraform/**'
  workflow_dispatch:
    inputs:
      workspace:
        description: 'TFC Workspace to trigger'
        required: false
        default: 'pr-cybr-mgmt-node'
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

jobs:
  tfc-bridge:
    name: Terraform Cloud Operations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check TFC Configuration
        id: check-tfc
        run: |
          if [ -z "${{ secrets.TFC_API_TOKEN }}"]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è TFC_API_TOKEN not configured"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup Terraform
        if: steps.check-tfc.outputs.configured == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.0"
          cli_config_credentials_token: ${{ secrets.TFC_API_TOKEN }}

      - name: Terraform Init
        if: steps.check-tfc.outputs.configured == 'true' && hashFiles('config/terraform/**/*.tf') != ''
        run: |
          cd config/terraform
          terraform init

      - name: Terraform Plan
        if: steps.check-tfc.outputs.configured == 'true' && hashFiles('config/terraform/**/*.tf') != ''
        id: plan
        run: |
          cd config/terraform
          terraform plan -no-color -out=tfplan
        continue-on-error: true

      - name: Terraform Apply
        if: |
          steps.check-tfc.outputs.configured == 'true' &&
          hashFiles('config/terraform/**/*.tf') != '' &&
          github.ref == 'refs/heads/main' &&
          github.event_name == 'push' &&
          (github.event.inputs.action == 'apply' || github.event.inputs.action == '')
        run: |
          cd config/terraform
          terraform apply -auto-approve tfplan

      - name: Notify Slack on Success
        if: success() && steps.check-tfc.outputs.configured == 'true'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}"]; then
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H 'Content-Type: application/json' \
              -d "{
                \"text\": \"‚úÖ Terraform Cloud operation completed successfully\",
                \"blocks\": [{
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Terraform Cloud Bridge*\\n‚úÖ Operation: \`${{ github.event.inputs.action || 'plan' }}\`\\nWorkspace: \`${{ github.event.inputs.workspace || 'pr-cybr-mgmt-node' }}\`\\nCommit: <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\"
                  }
                }]
              }"
          fi

      - name: Notify Slack on Failure
        if: failure() && steps.check-tfc.outputs.configured == 'true'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}"]; then
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H 'Content-Type: application/json' \
              -d "{
                \"text\": \"‚ùå Terraform Cloud operation failed\",
                \"blocks\": [{
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Terraform Cloud Bridge*\\n‚ùå Operation: \`${{ github.event.inputs.action || 'plan' }}\`\\nWorkspace: \`${{ github.event.inputs.workspace || 'pr-cybr-mgmt-node' }}\`\\nCommit: <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>\"
                  }
                }]
              }"
          fi

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request' && steps.plan.outcome != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Plan üìñ

            <details><summary>Show Plan</summary>

            \`\`\`
            ${{ steps.plan.outputs.stdout }}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
