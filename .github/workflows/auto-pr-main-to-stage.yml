name: Auto PR from main to stage

on:
  workflow_run:
    workflows: ["Build", "Lint", "Test"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate GitHub Context
        run: |
          echo "üîç Repository Owner: ${{ github.repository_owner }}"
          echo "üì¶ Repository: ${{ github.repository }}"
          if [ -z "${{ github.repository_owner }}" ]; then
            echo "‚ùå Missing repository context."
            exit 1
          fi

      - name: Create or Update PR (main ‚Üí stage)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const source = "main";
            const target = "stage";

            core.info(`üîÑ Checking for existing PR from ${source} ‚Üí ${target}`);

            try {
              // List existing PRs (modern syntax)
              const { data: pulls } = await github.rest.pulls.list({
                owner,
                repo,
                state: "open",
                head: `${owner}:${source}`,
                base: target
              });

              if (Array.isArray(pulls) && pulls.length > 0) {
                core.info(`‚úÖ Existing PR found: ${pulls[0].html_url}`);
              } else {
                core.info("üÜï No PR found. Creating a new one...");

                const pr = await github.rest.pulls.create({
                  owner,
                  repo,
                  head: source,
                  base: target,
                  title: `üîÑ Auto PR from ${source} ‚Üí ${target}`,
                  body: "Automated PR to merge changes from **main** into **stage**."
                });

                core.info(`‚úÖ Created PR: ${pr.data.html_url}`);
              }
            } catch (error) {
              if (error.message.includes("undefined")) {
                core.warning("‚ö†Ô∏è Undefined reference encountered ‚Äî possibly from deprecated API usage.");
              } else {
                core.setFailed(`‚ùå Unhandled error: ${error.message}`);
              }
            }

      - name: Optional Auto-Merge (if checks pass)
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const target = "stage";

            try {
              const { data: prs } = await github.rest.pulls.list({
                owner,
                repo,
                state: "open",
                base: target,
              });

              if (prs.length === 0) {
                core.info("No open PRs to merge.");
                return;
              }

              const pr = prs[0];
              core.info(`üß© Attempting to auto-merge PR #${pr.number} (${pr.title})`);

              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: pr.number,
                merge_method: "squash"
              });

              core.info(`‚úÖ Successfully merged PR #${pr.number}`);
            } catch (error) {
              core.warning(`‚ö†Ô∏è Auto-merge skipped: ${error.message}`);
            }

      - name: Log Completion
        run: echo "‚úÖ Auto PR workflow completed successfully."
