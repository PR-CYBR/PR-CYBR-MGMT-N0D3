name: Auto PR from main to stage

on:
  workflow_run:
    # NOTE: If these workflow names change, update them here to maintain automation
    # These workflows must be defined in .github/workflows/ directory
    workflows: ["Build", "Lint", "Test"]
    branches: [main]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate GitHub Context
        run: |
          echo "üîç Repository Owner: ${{ github.repository_owner }}"
          echo "üì¶ Repository: ${{ github.repository }}"
          if [ -z "${{ github.repository_owner }}" ]; then
            echo "‚ùå Missing repository context."
            exit 1
          fi

      - name: Create or Update PR (main ‚Üí stage)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const source = "main";
            const target = "stage";

            core.info(`üîÑ Checking for existing PR from ${source} ‚Üí ${target}`);

            try {
              // List existing PRs (modern syntax)
              const { data: pulls } = await github.rest.pulls.list({
                owner,
                repo,
                state: "open",
                head: `${owner}:${source}`,
                base: target
              });

              if (Array.isArray(pulls) && pulls.length > 0) {
                core.info(`‚úÖ Existing PR found: ${pulls[0].html_url}`);
              } else {
                core.info("üÜï No PR found. Creating a new one...");

                const pr = await github.rest.pulls.create({
                  owner,
                  repo,
                  head: source,
                  base: target,
                  title: `üîÑ Auto PR from ${source} ‚Üí ${target}`,
                  body: "Automated PR to merge changes from **main** into **stage**."
                });

                core.info(`‚úÖ Created PR: ${pr.data.html_url}`);
              }
            } catch (error) {
              if (error.status === 404) {
                core.setFailed(`‚ùå Resource not found: ${error.message}`);
              } else if (error.status === 403) {
                core.setFailed(`‚ùå Permission denied: ${error.message}`);
              } else if (error.message && error.message.includes("undefined")) {
                core.warning("‚ö†Ô∏è Undefined reference encountered ‚Äî possibly from deprecated API usage.");
              } else {
                core.setFailed(`‚ùå API error (${error.status || 'unknown'}): ${error.message}`);
              }
            }

      - name: Optional Auto-Merge (if checks pass)
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const source = "main";
            const target = "stage";

            try {
              const { data: prs } = await github.rest.pulls.list({
                owner,
                repo,
                state: "open",
                head: `${owner}:${source}`,
                base: target,
              });

              if (prs.length === 0) {
                core.info("No open PRs to merge.");
                return;
              }

              const pr = prs[0];
              core.info(`üß© Attempting to auto-merge PR #${pr.number} (${pr.title})`);

              // Check if PR is mergeable (null means GitHub is still computing)
              if (pr.mergeable === null) {
                core.warning(`‚ö†Ô∏è PR #${pr.number} mergeability is still being computed. Skipping auto-merge.`);
                return;
              }

              if (pr.mergeable === false) {
                core.warning(`‚ö†Ô∏è PR #${pr.number} is not mergeable (conflicts exist).`);
                return;
              }

              if (pr.mergeable_state !== 'clean') {
                core.warning(`‚ö†Ô∏è PR #${pr.number} mergeable_state is '${pr.mergeable_state}' (not 'clean').` +
                  ` Required checks may not have passed.`);
                return;
              }

              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: pr.number,
                merge_method: "squash"
              });

              core.info(`‚úÖ Successfully merged PR #${pr.number}`);
            } catch (error) {
              core.warning(`‚ö†Ô∏è Auto-merge skipped: ${error.message}`);
            }

      - name: Log Completion
        run: echo "‚úÖ Auto PR workflow completed successfully."
